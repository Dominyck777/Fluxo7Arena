ANTES DE ATUALIZAR ESSE ARQUIVO, O USUARIO PRECISA ATUALIZAR O BANCO DE DADOS COM A NOVA ESTRUTURA.


[
  {
    "db_catalog_json": {
      "schemas": [
        {
          "schema": "auth",
          "tables": [
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "instance_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "payload",
                  "type": "json",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "ip_address",
                  "type": "character varying(64)",
                  "comment": null,
                  "default": "''::character varying",
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "audit_log_entries_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX audit_log_entries_pkey ON auth.audit_log_entries USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "audit_logs_instance_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX audit_logs_instance_id_idx ON auth.audit_log_entries USING btree (instance_id)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "audit_log_entries",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "audit_log_entries_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Audit trail for user actions.",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "auth_code",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "code_challenge_method",
                  "type": "auth.code_challenge_method",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "code_challenge",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "provider_type",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "provider_access_token",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "provider_refresh_token",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "authentication_method",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "auth_code_issued_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 12,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "flow_state_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX flow_state_pkey ON auth.flow_state USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "idx_auth_code",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_auth_code ON auth.flow_state USING btree (auth_code)",
                  "is_primary": false
                },
                {
                  "name": "idx_user_id_auth_method",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_user_id_auth_method ON auth.flow_state USING btree (user_id, authentication_method)",
                  "is_primary": false
                },
                {
                  "name": "flow_state_created_at_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX flow_state_created_at_idx ON auth.flow_state USING btree (created_at DESC)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "flow_state",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "flow_state_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "stores metadata for pkce logins",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "provider_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "identity_data",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "provider",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "last_sign_in_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email",
                  "type": "text",
                  "comment": "Auth: Email is a generated column that references the optional email property in the identity_data",
                  "default": "lower((identity_data ->> 'email'::text))",
                  "nullable": true,
                  "position": 8,
                  "generated_kind": "s",
                  "identity_generation": null
                },
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "identities_user_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX identities_user_id_idx ON auth.identities USING btree (user_id)",
                  "is_primary": false
                },
                {
                  "name": "identities_email_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX identities_email_idx ON auth.identities USING btree (email text_pattern_ops)",
                  "is_primary": false
                },
                {
                  "name": "identities_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX identities_pkey ON auth.identities USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "identities_provider_id_provider_unique",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX identities_provider_id_provider_unique ON auth.identities USING btree (provider_id, provider)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "identities",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "identities_user_id_fkey",
                  "ref_table": "users",
                  "definition": "FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "identities_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Stores identities associated to a user.",
              "check_constraints": [],
              "unique_constraints": [
                {
                  "name": "identities_provider_id_provider_unique",
                  "columns": [
                    "provider_id",
                    "provider"
                  ],
                  "definition": "UNIQUE (provider_id, provider)"
                }
              ]
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "uuid",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "raw_base_config",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "instances_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX instances_pkey ON auth.instances USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "instances",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "instances_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Manages users across multiple sites.",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "session_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "authentication_method",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "mfa_amr_claims_session_id_authentication_method_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX mfa_amr_claims_session_id_authentication_method_pkey ON auth.mfa_amr_claims USING btree (session_id, authentication_method)",
                  "is_primary": false
                },
                {
                  "name": "amr_id_pk",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX amr_id_pk ON auth.mfa_amr_claims USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "mfa_amr_claims",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "mfa_amr_claims_session_id_fkey",
                  "ref_table": "sessions",
                  "definition": "FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "amr_id_pk",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "auth: stores authenticator method reference claims for multi factor authentication",
              "check_constraints": [],
              "unique_constraints": [
                {
                  "name": "mfa_amr_claims_session_id_authentication_method_pkey",
                  "columns": [
                    "session_id",
                    "authentication_method"
                  ],
                  "definition": "UNIQUE (session_id, authentication_method)"
                }
              ]
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "factor_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "verified_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "ip_address",
                  "type": "inet",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "otp_code",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "web_authn_session_data",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "mfa_challenges_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX mfa_challenges_pkey ON auth.mfa_challenges USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "mfa_challenge_created_at_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX mfa_challenge_created_at_idx ON auth.mfa_challenges USING btree (created_at DESC)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "mfa_challenges",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "mfa_challenges_auth_factor_id_fkey",
                  "ref_table": "mfa_factors",
                  "definition": "FOREIGN KEY (factor_id) REFERENCES auth.mfa_factors(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "mfa_challenges_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "auth: stores metadata about challenge requests made",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "friendly_name",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "factor_type",
                  "type": "auth.factor_type",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "status",
                  "type": "auth.factor_status",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "secret",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "phone",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "last_challenged_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "web_authn_credential",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "web_authn_aaguid",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 12,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "mfa_factors_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX mfa_factors_pkey ON auth.mfa_factors USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "mfa_factors_user_friendly_name_unique",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX mfa_factors_user_friendly_name_unique ON auth.mfa_factors USING btree (friendly_name, user_id) WHERE (TRIM(BOTH FROM friendly_name) <> ''::text)",
                  "is_primary": false
                },
                {
                  "name": "factor_id_created_at_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX factor_id_created_at_idx ON auth.mfa_factors USING btree (user_id, created_at)",
                  "is_primary": false
                },
                {
                  "name": "mfa_factors_user_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX mfa_factors_user_id_idx ON auth.mfa_factors USING btree (user_id)",
                  "is_primary": false
                },
                {
                  "name": "unique_phone_factor_per_user",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX unique_phone_factor_per_user ON auth.mfa_factors USING btree (user_id, phone)",
                  "is_primary": false
                },
                {
                  "name": "mfa_factors_last_challenged_at_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX mfa_factors_last_challenged_at_key ON auth.mfa_factors USING btree (last_challenged_at)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "mfa_factors",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "mfa_factors_user_id_fkey",
                  "ref_table": "users",
                  "definition": "FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "mfa_factors_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "auth: stores metadata about factors",
              "check_constraints": [],
              "unique_constraints": [
                {
                  "name": "mfa_factors_last_challenged_at_key",
                  "columns": [
                    "last_challenged_at"
                  ],
                  "definition": "UNIQUE (last_challenged_at)"
                }
              ]
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "token_type",
                  "type": "auth.one_time_token_type",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "token_hash",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "relates_to",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp without time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp without time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": false,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "one_time_tokens_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX one_time_tokens_pkey ON auth.one_time_tokens USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "one_time_tokens_token_hash_hash_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX one_time_tokens_token_hash_hash_idx ON auth.one_time_tokens USING hash (token_hash)",
                  "is_primary": false
                },
                {
                  "name": "one_time_tokens_relates_to_hash_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX one_time_tokens_relates_to_hash_idx ON auth.one_time_tokens USING hash (relates_to)",
                  "is_primary": false
                },
                {
                  "name": "one_time_tokens_user_id_token_type_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX one_time_tokens_user_id_token_type_key ON auth.one_time_tokens USING btree (user_id, token_type)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "one_time_tokens",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "one_time_tokens_user_id_fkey",
                  "ref_table": "users",
                  "definition": "FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "one_time_tokens_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [
                {
                  "name": "one_time_tokens_token_hash_check",
                  "definition": "CHECK ((char_length(token_hash) > 0))"
                }
              ],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "instance_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "id",
                  "type": "bigint",
                  "comment": null,
                  "default": "nextval('auth.refresh_tokens_id_seq'::regclass)",
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "token",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_id",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "revoked",
                  "type": "boolean",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "parent",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "session_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "refresh_tokens_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX refresh_tokens_pkey ON auth.refresh_tokens USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "refresh_tokens_instance_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX refresh_tokens_instance_id_idx ON auth.refresh_tokens USING btree (instance_id)",
                  "is_primary": false
                },
                {
                  "name": "refresh_tokens_instance_id_user_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX refresh_tokens_instance_id_user_id_idx ON auth.refresh_tokens USING btree (instance_id, user_id)",
                  "is_primary": false
                },
                {
                  "name": "refresh_tokens_token_unique",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX refresh_tokens_token_unique ON auth.refresh_tokens USING btree (token)",
                  "is_primary": false
                },
                {
                  "name": "refresh_tokens_parent_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX refresh_tokens_parent_idx ON auth.refresh_tokens USING btree (parent)",
                  "is_primary": false
                },
                {
                  "name": "refresh_tokens_session_id_revoked_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX refresh_tokens_session_id_revoked_idx ON auth.refresh_tokens USING btree (session_id, revoked)",
                  "is_primary": false
                },
                {
                  "name": "refresh_tokens_updated_at_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX refresh_tokens_updated_at_idx ON auth.refresh_tokens USING btree (updated_at DESC)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "refresh_tokens",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "refresh_tokens_session_id_fkey",
                  "ref_table": "sessions",
                  "definition": "FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "refresh_tokens_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Store of tokens used to refresh JWT tokens once they expire.",
              "check_constraints": [],
              "unique_constraints": [
                {
                  "name": "refresh_tokens_token_unique",
                  "columns": [
                    "token"
                  ],
                  "definition": "UNIQUE (token)"
                }
              ]
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "sso_provider_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "entity_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "metadata_xml",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "metadata_url",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "attribute_mapping",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "name_id_format",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "saml_providers_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX saml_providers_pkey ON auth.saml_providers USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "saml_providers_entity_id_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX saml_providers_entity_id_key ON auth.saml_providers USING btree (entity_id)",
                  "is_primary": false
                },
                {
                  "name": "saml_providers_sso_provider_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX saml_providers_sso_provider_id_idx ON auth.saml_providers USING btree (sso_provider_id)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "saml_providers",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "saml_providers_sso_provider_id_fkey",
                  "ref_table": "sso_providers",
                  "definition": "FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "saml_providers_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Manages SAML Identity Provider connections.",
              "check_constraints": [
                {
                  "name": "entity_id not empty",
                  "definition": "CHECK ((char_length(entity_id) > 0))"
                },
                {
                  "name": "metadata_url not empty",
                  "definition": "CHECK (((metadata_url = NULL::text) OR (char_length(metadata_url) > 0)))"
                },
                {
                  "name": "metadata_xml not empty",
                  "definition": "CHECK ((char_length(metadata_xml) > 0))"
                }
              ],
              "unique_constraints": [
                {
                  "name": "saml_providers_entity_id_key",
                  "columns": [
                    "entity_id"
                  ],
                  "definition": "UNIQUE (entity_id)"
                }
              ]
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "sso_provider_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "request_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "for_email",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "redirect_to",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "flow_state_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "saml_relay_states_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX saml_relay_states_pkey ON auth.saml_relay_states USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "saml_relay_states_sso_provider_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX saml_relay_states_sso_provider_id_idx ON auth.saml_relay_states USING btree (sso_provider_id)",
                  "is_primary": false
                },
                {
                  "name": "saml_relay_states_for_email_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX saml_relay_states_for_email_idx ON auth.saml_relay_states USING btree (for_email)",
                  "is_primary": false
                },
                {
                  "name": "saml_relay_states_created_at_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX saml_relay_states_created_at_idx ON auth.saml_relay_states USING btree (created_at DESC)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "saml_relay_states",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "saml_relay_states_flow_state_id_fkey",
                  "ref_table": "flow_state",
                  "definition": "FOREIGN KEY (flow_state_id) REFERENCES auth.flow_state(id) ON DELETE CASCADE",
                  "ref_schema": null
                },
                {
                  "name": "saml_relay_states_sso_provider_id_fkey",
                  "ref_table": "sso_providers",
                  "definition": "FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "saml_relay_states_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Contains SAML Relay State information for each Service Provider initiated login.",
              "check_constraints": [
                {
                  "name": "request_id not empty",
                  "definition": "CHECK ((char_length(request_id) > 0))"
                }
              ],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "version",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "schema_migrations_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX schema_migrations_pkey ON auth.schema_migrations USING btree (version)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "schema_migrations",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "schema_migrations_pkey",
                  "columns": [
                    "version"
                  ],
                  "definition": "PRIMARY KEY (version)"
                }
              ],
              "table_comment": "Auth: Manages updates to the auth system.",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "factor_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "aal",
                  "type": "auth.aal_level",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "not_after",
                  "type": "timestamp with time zone",
                  "comment": "Auth: Not after is a nullable column that contains a timestamp after which the session should be regarded as expired.",
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "refreshed_at",
                  "type": "timestamp without time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_agent",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "ip",
                  "type": "inet",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "tag",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "sessions_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX sessions_pkey ON auth.sessions USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "user_id_created_at_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX user_id_created_at_idx ON auth.sessions USING btree (user_id, created_at)",
                  "is_primary": false
                },
                {
                  "name": "sessions_user_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX sessions_user_id_idx ON auth.sessions USING btree (user_id)",
                  "is_primary": false
                },
                {
                  "name": "sessions_not_after_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX sessions_not_after_idx ON auth.sessions USING btree (not_after DESC)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "sessions",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "sessions_user_id_fkey",
                  "ref_table": "users",
                  "definition": "FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "sessions_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Stores session data associated to a user.",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "sso_provider_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "domain",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "sso_domains_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX sso_domains_pkey ON auth.sso_domains USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "sso_domains_sso_provider_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX sso_domains_sso_provider_id_idx ON auth.sso_domains USING btree (sso_provider_id)",
                  "is_primary": false
                },
                {
                  "name": "sso_domains_domain_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX sso_domains_domain_idx ON auth.sso_domains USING btree (lower(domain))",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "sso_domains",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "sso_domains_sso_provider_id_fkey",
                  "ref_table": "sso_providers",
                  "definition": "FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "sso_domains_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Manages SSO email address domain mapping to an SSO Identity Provider.",
              "check_constraints": [
                {
                  "name": "domain not empty",
                  "definition": "CHECK ((char_length(domain) > 0))"
                }
              ],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "resource_id",
                  "type": "text",
                  "comment": "Auth: Uniquely identifies a SSO provider according to a user-chosen resource ID (case insensitive), useful in infrastructure as code.",
                  "default": null,
                  "nullable": true,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "disabled",
                  "type": "boolean",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "sso_providers_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX sso_providers_pkey ON auth.sso_providers USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "sso_providers_resource_id_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX sso_providers_resource_id_idx ON auth.sso_providers USING btree (lower(resource_id))",
                  "is_primary": false
                },
                {
                  "name": "sso_providers_resource_id_pattern_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX sso_providers_resource_id_pattern_idx ON auth.sso_providers USING btree (resource_id text_pattern_ops)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "sso_providers",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "sso_providers_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Manages SSO identity provider information; see saml_providers for SAML.",
              "check_constraints": [
                {
                  "name": "resource_id not empty",
                  "definition": "CHECK (((resource_id = NULL::text) OR (char_length(resource_id) > 0)))"
                }
              ],
              "unique_constraints": []
            },
            {
              "schema": "auth",
              "columns": [
                {
                  "name": "instance_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "aud",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "role",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "encrypted_password",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email_confirmed_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "invited_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "confirmation_token",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "confirmation_sent_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "recovery_token",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "recovery_sent_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 12,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email_change_token_new",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 13,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email_change",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 14,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email_change_sent_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 15,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "last_sign_in_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 16,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "raw_app_meta_data",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 17,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "raw_user_meta_data",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 18,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "is_super_admin",
                  "type": "boolean",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 19,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 20,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 21,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "phone",
                  "type": "text",
                  "comment": null,
                  "default": "NULL::character varying",
                  "nullable": true,
                  "position": 22,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "phone_confirmed_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 23,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "phone_change",
                  "type": "text",
                  "comment": null,
                  "default": "''::character varying",
                  "nullable": true,
                  "position": 24,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "phone_change_token",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": "''::character varying",
                  "nullable": true,
                  "position": 25,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "phone_change_sent_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 26,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "confirmed_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "LEAST(email_confirmed_at, phone_confirmed_at)",
                  "nullable": true,
                  "position": 27,
                  "generated_kind": "s",
                  "identity_generation": null
                },
                {
                  "name": "email_change_token_current",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": "''::character varying",
                  "nullable": true,
                  "position": 28,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email_change_confirm_status",
                  "type": "smallint",
                  "comment": null,
                  "default": "0",
                  "nullable": true,
                  "position": 29,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "banned_until",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 30,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "reauthentication_token",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": "''::character varying",
                  "nullable": true,
                  "position": 31,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "reauthentication_sent_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 32,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "is_sso_user",
                  "type": "boolean",
                  "comment": "Auth: Set this column to true when the account comes from SSO. These accounts can have duplicate emails.",
                  "default": "false",
                  "nullable": false,
                  "position": 33,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "deleted_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 34,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "is_anonymous",
                  "type": "boolean",
                  "comment": null,
                  "default": "false",
                  "nullable": false,
                  "position": 35,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "users_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX users_pkey ON auth.users USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "users_instance_id_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX users_instance_id_idx ON auth.users USING btree (instance_id)",
                  "is_primary": false
                },
                {
                  "name": "users_instance_id_email_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX users_instance_id_email_idx ON auth.users USING btree (instance_id, lower((email)::text))",
                  "is_primary": false
                },
                {
                  "name": "confirmation_token_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX confirmation_token_idx ON auth.users USING btree (confirmation_token) WHERE ((confirmation_token)::text !~ '^[0-9 ]*$'::text)",
                  "is_primary": false
                },
                {
                  "name": "recovery_token_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX recovery_token_idx ON auth.users USING btree (recovery_token) WHERE ((recovery_token)::text !~ '^[0-9 ]*$'::text)",
                  "is_primary": false
                },
                {
                  "name": "email_change_token_current_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX email_change_token_current_idx ON auth.users USING btree (email_change_token_current) WHERE ((email_change_token_current)::text !~ '^[0-9 ]*$'::text)",
                  "is_primary": false
                },
                {
                  "name": "email_change_token_new_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX email_change_token_new_idx ON auth.users USING btree (email_change_token_new) WHERE ((email_change_token_new)::text !~ '^[0-9 ]*$'::text)",
                  "is_primary": false
                },
                {
                  "name": "reauthentication_token_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX reauthentication_token_idx ON auth.users USING btree (reauthentication_token) WHERE ((reauthentication_token)::text !~ '^[0-9 ]*$'::text)",
                  "is_primary": false
                },
                {
                  "name": "users_email_partial_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX users_email_partial_key ON auth.users USING btree (email) WHERE (is_sso_user = false)",
                  "is_primary": false
                },
                {
                  "name": "users_phone_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX users_phone_key ON auth.users USING btree (phone)",
                  "is_primary": false
                },
                {
                  "name": "users_is_anonymous_idx",
                  "is_unique": false,
                  "definition": "CREATE INDEX users_is_anonymous_idx ON auth.users USING btree (is_anonymous)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "users",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "users_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Auth: Stores user login data within a secure schema.",
              "check_constraints": [
                {
                  "name": "users_email_change_confirm_status_check",
                  "definition": "CHECK (((email_change_confirm_status >= 0) AND (email_change_confirm_status <= 2)))"
                }
              ],
              "unique_constraints": [
                {
                  "name": "users_phone_key",
                  "columns": [
                    "phone"
                  ],
                  "definition": "UNIQUE (phone)"
                }
              ]
            }
          ]
        },
        {
          "schema": "extensions",
          "tables": []
        },
        {
          "schema": "graphql",
          "tables": []
        },
        {
          "schema": "graphql_public",
          "tables": []
        },
        {
          "schema": "pgbouncer",
          "tables": []
        },
        {
          "schema": "public",
          "tables": [
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "empresa_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "quadra_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "cliente_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "clientes",
                  "type": "text[]",
                  "comment": "Participantes (nomes)",
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "inicio",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "fim",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "modalidade",
                  "type": "character varying(100)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "status",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": "'scheduled'::character varying",
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "valor",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "bookings_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX bookings_pkey ON public.agendamentos USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "agendamentos",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "bookings_company_id_fkey",
                  "ref_table": "empresas",
                  "definition": "FOREIGN KEY (empresa_id) REFERENCES empresas(id)",
                  "ref_schema": null
                },
                {
                  "name": "bookings_court_id_fkey",
                  "ref_table": "quadras",
                  "definition": "FOREIGN KEY (quadra_id) REFERENCES quadras(id)",
                  "ref_schema": null
                },
                {
                  "name": "bookings_customer_id_fkey",
                  "ref_table": "clientes",
                  "definition": "FOREIGN KEY (cliente_id) REFERENCES clientes(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "bookings_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Clientes. Cdigo sequencial por empresa gerado via trigger 'zz_clientes_set_codigo' que chama a funo 'public.clientes_set_codigo_fn()'. Usa a tabela 'public.empresa_counters' como fonte de numerao.",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "empresa_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "next_cliente_codigo",
                  "type": "integer",
                  "comment": "Prximo cdigo sequencial para clientes da empresa",
                  "default": "1",
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "empresa_counters",
              "rls_enabled": false,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "empresa_counters_pkey",
                  "columns": [
                    "empresa_id"
                  ],
                  "definition": "PRIMARY KEY (empresa_id)"
                }
              ],
              "table_comment": "Tabela auxiliar para controle de numerao sequencial por empresa (clientes). Usada por 'public.clientes_set_codigo_fn()'.",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "empresa_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "agendamento_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "cliente_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nome",
                  "type": "text",
                  "comment": "Nome do participante quando no houver cliente_id",
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "valor_cota",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "status_pagamento",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": "'pendente'::character varying",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "pago_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "metodo_pagamento",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "agendamento_participantes_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX agendamento_participantes_pkey ON public.agendamento_participantes USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "agendamento_participantes",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "agp_empresa_id_fkey",
                  "ref_table": "empresas",
                  "definition": "FOREIGN KEY (empresa_id) REFERENCES empresas(id)",
                  "ref_schema": null
                },
                {
                  "name": "agp_agendamento_id_fkey",
                  "ref_table": "agendamentos",
                  "definition": "FOREIGN KEY (agendamento_id) REFERENCES agendamentos(id) ON DELETE CASCADE",
                  "ref_schema": null
                },
                {
                  "name": "agp_cliente_id_fkey",
                  "ref_table": "clientes",
                  "definition": "FOREIGN KEY (cliente_id) REFERENCES clientes(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "agendamento_participantes_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Participantes e cotas individuais de um agendamento",
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "empresa_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nome",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "cpf",
                  "type": "character varying(14)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "telefone",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "saldo",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": "0.00",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "status",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": "'active'::character varying",
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "aniversario",
                  "type": "date",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "atualizado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "codigo",
                  "type": "integer",
                  "comment": "Cdigo sequencial do cliente por empresa",
                  "default": null,
                  "nullable": false,
                  "position": 12,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "customers_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX customers_pkey ON public.clientes USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "idx_clientes_empresa_id",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_clientes_empresa_id ON public.clientes USING btree (empresa_id)",
                  "is_primary": false
                },
                {
                  "name": "idx_clientes_empresa_id_nome",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_clientes_empresa_id_nome ON public.clientes USING btree (empresa_id, nome)",
                  "is_primary": false
                },
                {
                  "name": "uq_clientes_empresa_cpf",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX uq_clientes_empresa_cpf ON public.clientes USING btree (empresa_id, cpf) WHERE (cpf IS NOT NULL)",
                  "is_primary": false
                },
                {
                  "name": "uq_clientes_empresa_email_lower",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX uq_clientes_empresa_email_lower ON public.clientes USING btree (empresa_id, lower(email)) WHERE (email IS NOT NULL)",
                  "is_primary": false
                },
                {
                  "name": "idx_clientes_empresa_telefone",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_clientes_empresa_telefone ON public.clientes USING btree (empresa_id, telefone)",
                  "is_primary": false
                },
                {
                  "name": "idx_clientes_empresa_aniversario",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_clientes_empresa_aniversario ON public.clientes USING btree (empresa_id, aniversario)",
                  "is_primary": false
                },
                {
                  "name": "uq_clientes_empresa_codigo",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX uq_clientes_empresa_codigo ON public.clientes USING btree (empresa_id, codigo)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "clientes",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "customers_company_id_fkey",
                  "ref_table": "empresas",
                  "definition": "FOREIGN KEY (empresa_id) REFERENCES empresas(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "customers_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "empresa_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nome",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "cargo",
                  "type": "character varying(50)",
                  "comment": null,
                  "default": "'user'::character varying",
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "atualizado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "user_profiles_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX user_profiles_pkey ON public.colaboradores USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "idx_colaboradores_empresa_id",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_colaboradores_empresa_id ON public.colaboradores USING btree (empresa_id)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "colaboradores",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "user_profiles_company_id_fkey",
                  "ref_table": "empresas",
                  "definition": "FOREIGN KEY (empresa_id) REFERENCES empresas(id)",
                  "ref_schema": null
                },
                {
                  "name": "user_profiles_id_fkey",
                  "ref_table": "users",
                  "definition": "FOREIGN KEY (id) REFERENCES auth.users(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "user_profiles_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "codigo_empresa",
                  "type": "character varying(10)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nome",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "telefone",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "endereco",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "atualizado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "companies_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX companies_pkey ON public.empresas USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "companies_company_code_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX companies_company_code_key ON public.empresas USING btree (codigo_empresa)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "empresas",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "companies_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": [
                {
                  "name": "companies_company_code_key",
                  "columns": [
                    "codigo_empresa"
                  ],
                  "definition": "UNIQUE (codigo_empresa)"
                }
              ]
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "venda_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "produto_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "quantidade",
                  "type": "integer",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "preco_unitario",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "preco_total",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "sale_items_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX sale_items_pkey ON public.itens_venda USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "itens_venda",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "sale_items_product_id_fkey",
                  "ref_table": "produtos",
                  "definition": "FOREIGN KEY (produto_id) REFERENCES produtos(id)",
                  "ref_schema": null
                },
                {
                  "name": "sale_items_sale_id_fkey",
                  "ref_table": "vendas",
                  "definition": "FOREIGN KEY (venda_id) REFERENCES vendas(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "sale_items_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "codigo_empresa",
                  "type": "character varying(10)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nome",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "valor_venda",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "categoria",
                  "type": "character varying(100)",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "status",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": "'active'::character varying",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "valor_custo",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": "0",
                  "nullable": false,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "validade",
                  "type": "date",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "estoque",
                  "type": "integer",
                  "comment": null,
                  "default": "0",
                  "nullable": false,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "estoque_minimo",
                  "type": "integer",
                  "comment": null,
                  "default": "0",
                  "nullable": false,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "tipo_produto",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": "'venda'::character varying",
                  "nullable": false,
                  "position": 12,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "products_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX products_pkey ON public.produtos USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "produtos_codigo_empresa_nome_unique",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX produtos_codigo_empresa_nome_unique ON public.produtos USING btree (codigo_empresa, lower(nome))",
                  "is_primary": false
                },
                {
                  "name": "idx_produtos_codigo_empresa",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_produtos_codigo_empresa ON public.produtos USING btree (codigo_empresa)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "produtos",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "products_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [
                {
                  "definition": "CHECK ((valor_custo >= 0))"
                },
                {
                  "definition": "CHECK ((estoque >= 0))"
                },
                {
                  "definition": "CHECK ((estoque_minimo >= 0))"
                },
                {
                  "definition": "CHECK ((tipo_produto)::text = ANY (ARRAY['venda'::text, 'uso_interno'::text]))"
                }
              ],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "empresa_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nome",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "modalidades",
                  "type": "text[]",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "tipo",
                  "type": "character varying(50)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "status",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": "'Ativa'::character varying",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "valor",
                  "type": "numeric(10,2)",
                  "comment": "Preo por meia hora (R$)",
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "courts_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX courts_pkey ON public.quadras USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "quadras_empresa_nome_unique",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX quadras_empresa_nome_unique ON public.quadras USING btree (empresa_id, nome)",
                  "is_primary": false
                },
                {
                  "name": "idx_quadras_empresa_id",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_quadras_empresa_id ON public.quadras USING btree (empresa_id)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "quadras",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "courts_company_id_fkey",
                  "ref_table": "empresas",
                  "definition": "FOREIGN KEY (empresa_id) REFERENCES empresas(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "courts_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "codigo_empresa",
                  "type": "character varying(10)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nome",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "email",
                  "type": "character varying(255)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "papel",
                  "type": "character varying(50)",
                  "comment": null,
                  "default": "'user'::character varying",
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "atualizado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "users_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX users_pkey ON public.usuarios USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "usuarios",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "usuarios_codigo_empresa_fkey",
                  "ref_table": "empresas",
                  "definition": "FOREIGN KEY (codigo_empresa) REFERENCES empresas(codigo_empresa)",
                  "ref_schema": null
                },
                {
                  "name": "users_id_fkey",
                  "ref_table": "users",
                  "definition": "FOREIGN KEY (id) REFERENCES auth.users(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "users_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "public",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "empresa_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "cliente_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "numero_mesa",
                  "type": "integer",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "valor_total",
                  "type": "numeric(10,2)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "status",
                  "type": "character varying(20)",
                  "comment": null,
                  "default": "'pending'::character varying",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "criado_em",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "sales_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX sales_pkey ON public.vendas USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "vendas",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "sales_company_id_fkey",
                  "ref_table": "empresas",
                  "definition": "FOREIGN KEY (empresa_id) REFERENCES empresas(id)",
                  "ref_schema": null
                },
                {
                  "name": "sales_customer_id_fkey",
                  "ref_table": "clientes",
                  "definition": "FOREIGN KEY (cliente_id) REFERENCES clientes(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "sales_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            }
          ]
        },
        {
          "schema": "realtime",
          "tables": [
            {
              "schema": "realtime",
              "columns": [
                {
                  "name": "topic",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "extension",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "payload",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "event",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "private",
                  "type": "boolean",
                  "comment": null,
                  "default": "false",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp without time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": false,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "inserted_at",
                  "type": "timestamp without time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": false,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "messages_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX messages_pkey ON ONLY realtime.messages USING btree (id, inserted_at)",
                  "is_primary": true
                }
              ],
              "relkind": "p",
              "rls_forced": false,
              "table_name": "messages",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "messages_pkey",
                  "columns": [
                    "inserted_at",
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id, inserted_at)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "realtime",
              "columns": [
                {
                  "name": "version",
                  "type": "bigint",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "inserted_at",
                  "type": "timestamp(0) without time zone",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "schema_migrations_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX schema_migrations_pkey ON realtime.schema_migrations USING btree (version)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "schema_migrations",
              "rls_enabled": false,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "schema_migrations_pkey",
                  "columns": [
                    "version"
                  ],
                  "definition": "PRIMARY KEY (version)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "realtime",
              "columns": [
                {
                  "name": "id",
                  "type": "bigint",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": "ALWAYS"
                },
                {
                  "name": "subscription_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "entity",
                  "type": "regclass",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "filters",
                  "type": "realtime.user_defined_filter[]",
                  "comment": null,
                  "default": "'{}'::realtime.user_defined_filter[]",
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "claims",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "claims_role",
                  "type": "regrole",
                  "comment": null,
                  "default": "realtime.to_regrole((claims ->> 'role'::text))",
                  "nullable": false,
                  "position": 8,
                  "generated_kind": "s",
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp without time zone",
                  "comment": null,
                  "default": "timezone('utc'::text, now())",
                  "nullable": false,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "pk_subscription",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX pk_subscription ON realtime.subscription USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "subscription_subscription_id_entity_filters_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX subscription_subscription_id_entity_filters_key ON realtime.subscription USING btree (subscription_id, entity, filters)",
                  "is_primary": false
                },
                {
                  "name": "ix_realtime_subscription_entity",
                  "is_unique": false,
                  "definition": "CREATE INDEX ix_realtime_subscription_entity ON realtime.subscription USING btree (entity)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "subscription",
              "rls_enabled": false,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "pk_subscription",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            }
          ]
        },
        {
          "schema": "storage",
          "tables": [
            {
              "schema": "storage",
              "columns": [
                {
                  "name": "id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "name",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "owner",
                  "type": "uuid",
                  "comment": "Field is deprecated, use owner_id instead",
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "public",
                  "type": "boolean",
                  "comment": null,
                  "default": "false",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "avif_autodetection",
                  "type": "boolean",
                  "comment": null,
                  "default": "false",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "file_size_limit",
                  "type": "bigint",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "allowed_mime_types",
                  "type": "text[]",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "owner_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "buckets_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX buckets_pkey ON storage.buckets USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "bname",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX bname ON storage.buckets USING btree (name)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "buckets",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "buckets_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "storage",
              "columns": [
                {
                  "name": "id",
                  "type": "integer",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "name",
                  "type": "character varying(100)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "hash",
                  "type": "character varying(40)",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "executed_at",
                  "type": "timestamp without time zone",
                  "comment": null,
                  "default": "CURRENT_TIMESTAMP",
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "migrations_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX migrations_pkey ON storage.migrations USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "migrations_name_key",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX migrations_name_key ON storage.migrations USING btree (name)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "migrations",
              "rls_enabled": true,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "migrations_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": [
                {
                  "name": "migrations_name_key",
                  "columns": [
                    "name"
                  ],
                  "definition": "UNIQUE (name)"
                }
              ]
            },
            {
              "schema": "storage",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "bucket_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "name",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "owner",
                  "type": "uuid",
                  "comment": "Field is deprecated, use owner_id instead",
                  "default": null,
                  "nullable": true,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "last_accessed_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "metadata",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "path_tokens",
                  "type": "text[]",
                  "comment": null,
                  "default": "string_to_array(name, '/'::text)",
                  "nullable": true,
                  "position": 9,
                  "generated_kind": "s",
                  "identity_generation": null
                },
                {
                  "name": "version",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "owner_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 11,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_metadata",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 12,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "objects_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX objects_pkey ON storage.objects USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "bucketid_objname",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX bucketid_objname ON storage.objects USING btree (bucket_id, name)",
                  "is_primary": false
                },
                {
                  "name": "name_prefix_search",
                  "is_unique": false,
                  "definition": "CREATE INDEX name_prefix_search ON storage.objects USING btree (name text_pattern_ops)",
                  "is_primary": false
                },
                {
                  "name": "idx_objects_bucket_id_name",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_objects_bucket_id_name ON storage.objects USING btree (bucket_id, name COLLATE \"C\")",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "objects",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "objects_bucketId_fkey",
                  "ref_table": "buckets",
                  "definition": "FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "objects_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "storage",
              "columns": [
                {
                  "name": "id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "in_progress_size",
                  "type": "bigint",
                  "comment": null,
                  "default": "0",
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "upload_signature",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "bucket_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "key",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "version",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "owner_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": false,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "user_metadata",
                  "type": "jsonb",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "s3_multipart_uploads_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX s3_multipart_uploads_pkey ON storage.s3_multipart_uploads USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "idx_multipart_uploads_list",
                  "is_unique": false,
                  "definition": "CREATE INDEX idx_multipart_uploads_list ON storage.s3_multipart_uploads USING btree (bucket_id, key, created_at)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "s3_multipart_uploads",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "s3_multipart_uploads_bucket_id_fkey",
                  "ref_table": "buckets",
                  "definition": "FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id)",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "s3_multipart_uploads_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            },
            {
              "schema": "storage",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "upload_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "size",
                  "type": "bigint",
                  "comment": null,
                  "default": "0",
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "part_number",
                  "type": "integer",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "bucket_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "key",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "etag",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "owner_id",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "version",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 9,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "now()",
                  "nullable": false,
                  "position": 10,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "s3_multipart_uploads_parts_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX s3_multipart_uploads_parts_pkey ON storage.s3_multipart_uploads_parts USING btree (id)",
                  "is_primary": true
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "s3_multipart_uploads_parts",
              "rls_enabled": true,
              "foreign_keys": [
                {
                  "name": "s3_multipart_uploads_parts_bucket_id_fkey",
                  "ref_table": "buckets",
                  "definition": "FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id)",
                  "ref_schema": null
                },
                {
                  "name": "s3_multipart_uploads_parts_upload_id_fkey",
                  "ref_table": "s3_multipart_uploads",
                  "definition": "FOREIGN KEY (upload_id) REFERENCES storage.s3_multipart_uploads(id) ON DELETE CASCADE",
                  "ref_schema": null
                }
              ],
              "primary_keys": [
                {
                  "name": "s3_multipart_uploads_parts_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": null,
              "check_constraints": [],
              "unique_constraints": []
            }
          ]
        },
        {
          "schema": "vault",
          "tables": [
            {
              "schema": "vault",
              "columns": [
                {
                  "name": "id",
                  "type": "uuid",
                  "comment": null,
                  "default": "gen_random_uuid()",
                  "nullable": false,
                  "position": 1,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "name",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 2,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "description",
                  "type": "text",
                  "comment": null,
                  "default": "''::text",
                  "nullable": false,
                  "position": 3,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "secret",
                  "type": "text",
                  "comment": null,
                  "default": null,
                  "nullable": false,
                  "position": 4,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "key_id",
                  "type": "uuid",
                  "comment": null,
                  "default": null,
                  "nullable": true,
                  "position": 5,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "nonce",
                  "type": "bytea",
                  "comment": null,
                  "default": "vault._crypto_aead_det_noncegen()",
                  "nullable": true,
                  "position": 6,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "created_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "CURRENT_TIMESTAMP",
                  "nullable": false,
                  "position": 7,
                  "generated_kind": null,
                  "identity_generation": null
                },
                {
                  "name": "updated_at",
                  "type": "timestamp with time zone",
                  "comment": null,
                  "default": "CURRENT_TIMESTAMP",
                  "nullable": false,
                  "position": 8,
                  "generated_kind": null,
                  "identity_generation": null
                }
              ],
              "indexes": [
                {
                  "name": "secrets_pkey",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX secrets_pkey ON vault.secrets USING btree (id)",
                  "is_primary": true
                },
                {
                  "name": "secrets_name_idx",
                  "is_unique": true,
                  "definition": "CREATE UNIQUE INDEX secrets_name_idx ON vault.secrets USING btree (name) WHERE (name IS NOT NULL)",
                  "is_primary": false
                }
              ],
              "relkind": "r",
              "rls_forced": false,
              "table_name": "secrets",
              "rls_enabled": false,
              "foreign_keys": [],
              "primary_keys": [
                {
                  "name": "secrets_pkey",
                  "columns": [
                    "id"
                  ],
                  "definition": "PRIMARY KEY (id)"
                }
              ],
              "table_comment": "Table with encrypted `secret` column for storing sensitive information on disk.",
              "check_constraints": [],
              "unique_constraints": []
            }
          ]
        }
      ],
      "database": "postgres",
      "generated_at": "2025-08-23T15:54:32.518912+00:00"
    }
  }
]

==== Alteraes Recentes (2025-08-23) ====
Contexto: Adicionados horrios de funcionamento padro por quadra.

Tabela: public.quadras
Novas colunas:
- hora_inicio time without time zone (NOT NULL)
- hora_fim    time without time zone (NOT NULL)

Restrio:
- CHECK (hora_fim > hora_inicio)

SQL de migrao aplicado/sugerido:

-- 1) Adicionar colunas com defaults para no quebrar registros existentes
ALTER TABLE public.quadras
  ADD COLUMN hora_inicio time without time zone NOT NULL DEFAULT '08:00',
  ADD COLUMN hora_fim    time without time zone NOT NULL DEFAULT '22:00';

-- 2) Garantir consistncia: fim > incio
ALTER TABLE public.quadras
  ADD CONSTRAINT quadras_horario_valido
  CHECK (hora_fim > hora_inicio);

-- 3) Remover defaults (opcional)
ALTER TABLE public.quadras
  ALTER COLUMN hora_inicio DROP DEFAULT,
  ALTER COLUMN hora_fim DROP DEFAULT;

-- 4) Comentrios (opcional)
COMMENT ON COLUMN public.quadras.hora_inicio IS 'Horrio padro de abertura da quadra';
COMMENT ON COLUMN public.quadras.hora_fim IS 'Horrio padro de fechamento da quadra';

==== Alteraes Recentes (2025-08-24) ====
Contexto: Aba Empresa passou a editar dados completos e fazer upload de logo via Storage.

Tabela: public.empresas
Novas colunas:
- razao_social text
- nome_fantasia text
- cnpj varchar(18)
- email text
- logo_url text

SQL de migrao aplicado:

-- 1) Adicionar colunas
ALTER TABLE public.empresas
  ADD COLUMN IF NOT EXISTS razao_social text,
  ADD COLUMN IF NOT EXISTS nome_fantasia text,
  ADD COLUMN IF NOT EXISTS cnpj varchar(18),
  ADD COLUMN IF NOT EXISTS email text,
  ADD COLUMN IF NOT EXISTS logo_url text;

-- 2) Popular iniciais (opcional)
UPDATE public.empresas
SET
  razao_social = COALESCE(razao_social, nome),
  nome_fantasia = COALESCE(nome_fantasia, nome)
WHERE true;

-- 3) Trigger para manter atualizado_em
CREATE OR REPLACE FUNCTION public.set_updated_at()
RETURNS trigger LANGUAGE plpgsql AS $$
BEGIN
  NEW.atualizado_em = now();
  RETURN NEW;
END $$;

DROP TRIGGER IF EXISTS empresas_set_updated_at ON public.empresas;
CREATE TRIGGER empresas_set_updated_at
BEFORE UPDATE ON public.empresas
FOR EACH ROW
EXECUTE FUNCTION public.set_updated_at();

-- 4) Policy de UPDATE (RLS)
DROP POLICY IF EXISTS empresas_update_user_company ON public.empresas;
CREATE POLICY empresas_update_user_company ON public.empresas
AS permissive
FOR UPDATE
TO authenticated
USING (
  id IN (SELECT empresa_id FROM public.colaboradores WHERE id = auth.uid())
)
WITH CHECK (
  id IN (SELECT empresa_id FROM public.colaboradores WHERE id = auth.uid())
);

-- 5) Storage: bucket e polticas para logos
INSERT INTO storage.buckets (id, name, public)
VALUES ('logos','logos', true)
ON CONFLICT (id) DO NOTHING;

DROP POLICY IF EXISTS logos_public_read ON storage.objects;
CREATE POLICY logos_public_read
ON storage.objects AS permissive
FOR SELECT TO public
USING (bucket_id = 'logos');

DROP POLICY IF EXISTS logos_write_own_company ON storage.objects;
CREATE POLICY logos_write_own_company
ON storage.objects AS permissive
FOR INSERT TO authenticated
WITH CHECK (
  bucket_id = 'logos' AND EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND name LIKE c.empresa_id::text || '/%'
  )
);

DROP POLICY IF EXISTS logos_update_own_company ON storage.objects;
CREATE POLICY logos_update_own_company
ON storage.objects AS permissive
FOR UPDATE TO authenticated
USING (
  bucket_id = 'logos' AND EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND name LIKE c.empresa_id::text || '/%'
  )
)
WITH CHECK (
  bucket_id = 'logos' AND EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND name LIKE c.empresa_id::text || '/%'
  )
);

DROP POLICY IF EXISTS logos_delete_own_company ON storage.objects;
CREATE POLICY logos_delete_own_company
ON storage.objects AS permissive
FOR DELETE TO authenticated
USING (
  bucket_id = 'logos' AND EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND name LIKE c.empresa_id::text || '/%'
  )
);

==== Alteraes Recentes (2025-08-24) ====
Contexto: Aba Equipe integrada  tabela public.colaboradores (listagem, criao, edio e desativao).

Tabela: public.colaboradores
Nova coluna:
- ativo boolean NOT NULL DEFAULT true

RLS: polticas por empresa (mantendo a poltica existente de seleo do prprio registro).

SQL de migrao sugerido:

-- 1) Coluna 'ativo'
ALTER TABLE public.colaboradores
  ADD COLUMN IF NOT EXISTS ativo boolean NOT NULL DEFAULT true;

-- 2) Habilitar RLS (se ainda no estiver)
ALTER TABLE public.colaboradores ENABLE ROW LEVEL SECURITY;

-- 3) Policies por empresa
DROP POLICY IF EXISTS colaboradores_select_company ON public.colaboradores;
CREATE POLICY colaboradores_select_company ON public.colaboradores
AS permissive
FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND c.empresa_id = public.colaboradores.empresa_id
  )
);

DROP POLICY IF EXISTS colaboradores_insert_company ON public.colaboradores;
CREATE POLICY colaboradores_insert_company ON public.colaboradores
AS permissive
FOR INSERT TO authenticated
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND c.empresa_id = public.colaboradores.empresa_id
  )
);

DROP POLICY IF EXISTS colaboradores_update_company ON public.colaboradores;
CREATE POLICY colaboradores_update_company ON public.colaboradores
AS permissive
FOR UPDATE TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND c.empresa_id = public.colaboradores.empresa_id
  )
)
WITH CHECK (
  EXISTS (
    SELECT 1 FROM public.colaboradores c
    WHERE c.id = auth.uid()
      AND c.empresa_id = public.colaboradores.empresa_id
  )
);

==== DDL Atualizado ====

-- ============================
-- ATUALIZAES APLICADAS (v2)
-- Data: 2025-08-25
-- Motivo: alinhar o esquema s regras RLS (por codigo_empresa) e s expectativas do front-end
-- Estas instrues devem ser executadas no banco. Mantemos o snapshot acima apenas como histrico.
-- ============================

-- 1) Tabela empresas
do $$
begin
  execute $$
    create table if not exists public.empresas (
      id uuid primary key default gen_random_uuid(),
      codigo_empresa text unique not null,
      nome text not null,
      telefone text,
      endereco text,
      criado_em timestamptz default now(),
      atualizado_em timestamptz default now()
    );
  $$;
exception when others then null;
end$$;

-- ============================
-- NOTA DE VERSO (v2.2)
-- Data: 2025-08-25
-- Escopo: Nenhuma alterao de esquema (DDL) nesta verso.
--         Apenas ajustes de polticas RLS documentados em estrutura_bd/politicas.txt (v2.2).
-- ============================

-- 2) Tabela colaboradores (id pode ser igual ao auth.uid() quando for usurio autenticado)
do $$
begin
  execute $$
    create table if not exists public.colaboradores (
      id uuid primary key,
      codigo_empresa text not null references public.empresas(codigo_empresa) on update cascade on delete restrict,
      nome text not null,
      cargo text default 'user',
      ativo boolean default true,
      criado_em timestamptz default now(),
      atualizado_em timestamptz default now()
    );
  $$;
  execute $$create index if not exists idx_colaboradores_codigo_empresa on public.colaboradores(codigo_empresa)$$;
exception when others then null;
end$$;

-- 3) Tabela usuarios (perfil opcional; no usada para criao de colaboradores)
do $$
begin
  execute $$
    create table if not exists public.usuarios (
      id uuid primary key references auth.users(id) on delete cascade,
      email text unique not null,
      papel text default 'user',
      codigo_empresa text references public.empresas(codigo_empresa) on update cascade on delete set null,
      criado_em timestamptz default now(),
      atualizado_em timestamptz default now()
    );
  $$;
  execute $$create index if not exists idx_usuarios_codigo_empresa on public.usuarios(codigo_empresa)$$;
exception when others then null;
end$$;

-- Observaes
-- - Coluna esperada no front-end: colaboradores(codigo_empresa, nome, cargo, ativo)
-- - Todo usurio autenticado deve ter um registro em colaboradores com id = auth.uid() e codigo_empresa vlido
-- - As polticas RLS que evitam recurso esto documentadas em estrutura_bd/politicas.txt

-- 4) (Opcional/Compatibilidade) Preencher colaboradores.empresa_id a partir de codigo_empresa
--    Use APENAS se sua tabela public.colaboradores ainda possuir a coluna empresa_id NOT NULL/FK
--    O bloco abaixo cria a funo e a trigger SOMENTE se a coluna existir, evitando erros em esquemas j migrados
do $$
declare
  v_has_empresa_id boolean;
begin
  select exists (
    select 1 from information_schema.columns
    where table_schema = 'public'
      and table_name   = 'colaboradores'
      and column_name  = 'empresa_id'
  ) into v_has_empresa_id;

  if v_has_empresa_id then
    -- Funo para setar empresa_id com base em codigo_empresa
    execute $$
    create or replace function public.set_colaborador_empresa_id()
    returns trigger
    language plpgsql
    security definer
    set search_path = public
    as $$
    begin
      if NEW.codigo_empresa is null then
        raise exception 'codigo_empresa obrigatrio';
      end if;

      select e.id into NEW.empresa_id
      from public.empresas e
      where e.codigo_empresa = NEW.codigo_empresa;

      if NEW.empresa_id is null then
        raise exception 'codigo_empresa invlido (empresa no encontrada)';
      end if;

      return NEW;
    end;
    $$;$$;

    -- Trigger antes de INSERT/UPDATE em codigo_empresa
    execute $$drop trigger if exists trg_set_colab_empresa_id on public.colaboradores$$;
    execute $$create trigger trg_set_colab_empresa_id
      before insert or update of codigo_empresa
      on public.colaboradores
      for each row
      execute procedure public.set_colaborador_empresa_id()$$;
  end if;
exception when others then null;
end$$;

-- Notas:
-- - Se sua tabela no possui empresa_id, este bloco no ter efeito (checagem dinmica de coluna).
-- - Em esquemas legados que ainda usam empresa_id, o front pode enviar apenas codigo_empresa; a trigger preenche empresa_id.
-- - Em esquemas novos, recomenda-se operar apenas com codigo_empresa conforme RLS em politicas.txt.

-- 5) (Recomendado) Remover a coluna empresa_id de public.colaboradores e operar s com codigo_empresa
--    Use este passo para concluir a migrao e eliminar dependncias legadas de empresa_id.
do $$
declare
  v_has_empresa_id boolean;
begin
  select exists (
    select 1 from information_schema.columns
    where table_schema = 'public'
      and table_name   = 'colaboradores'
      and column_name  = 'empresa_id'
  ) into v_has_empresa_id;

  if v_has_empresa_id then
    -- Remover trigger de compatibilidade, se existir
    execute $$drop trigger if exists trg_set_colab_empresa_id on public.colaboradores$$;
    -- Remover funo de compatibilidade, se no estiver sendo usada por outras triggers
    execute $$drop function if exists public.set_colaborador_empresa_id() cascade$$;

    -- Dropar constraints que referenciem empresa_id, se houver
    -- Obs.: ajuste nomes de constraints se seu esquema usar nomes diferentes
    begin
      perform 1 from pg_constraint c
      join pg_class t on t.oid = c.conrelid
      where t.relname = 'colaboradores' and c.conname = 'colaboradores_empresa_id_fkey';
      if found then
        execute $$alter table public.colaboradores drop constraint colaboradores_empresa_id_fkey$$;
      end if;
    exception when others then null; end;

    -- Finalmente, dropar a coluna empresa_id
    execute $$alter table public.colaboradores drop column if exists empresa_id$$;
  end if;
exception when others then null;
end$$;

-- Aps este passo, garanta que o FK de codigo_empresa permanece ativo (conforme item 2) e siga as RLS por codigo_empresa.

-- 5.X) Remoo completa e idempotente de QUALQUER vnculo com a coluna empresa_id em public.colaboradores
--      Este bloco remove policies, ndices, constraints e triggers que referenciem empresa_id
--      e por fim remove a coluna. Seguro para rodar mltiplas vezes.
do $$
declare
  v_schema text := 'public';
  v_table  text := 'colaboradores';
  v_column text := 'empresa_id';
  r record;
begin
  -- 1) Dropar RLS policies que referenciem empresa_id
  for r in
    select policyname
    from pg_policies
    where schemaname = v_schema
      and tablename  = v_table
      and (
        coalesce(qual, '')        ilike '%' || v_column || '%'
        or coalesce(with_check,'') ilike '%' || v_column || '%'
      )
  loop
    execute format('drop policy if exists %I on %I.%I', r.policyname, v_schema, v_table);
  end loop;
end
$$ language plpgsql;

do $$
declare
  v_schema text := 'public';
  v_table  text := 'colaboradores';
  v_column text := 'empresa_id';
  r record;
begin
  -- 2) Dropar ndices que incluam empresa_id
  for r in
    select ic.relname as index_name
    from pg_index i
    join pg_class t on t.oid = i.indrelid
    join pg_namespace n on n.oid = t.relnamespace
    join pg_class ic on ic.oid = i.indexrelid
    where n.nspname = v_schema
      and t.relname = v_table
      and exists (
        select 1
        from unnest(i.indkey) as k(attnum)
        join pg_attribute a on a.attrelid = t.oid and a.attnum = k.attnum
        where a.attname = v_column
      )
  loop
    execute format('drop index if exists %I.%I', v_schema, r.index_name);
  end loop;
end
$$ language plpgsql;

do $$
declare
  v_schema text := 'public';
  v_table  text := 'colaboradores';
  v_column text := 'empresa_id';
  r record;
begin
  -- 3) Dropar constraints (FK/UNIQUE/CHECK) que referenciem empresa_id
  for r in
    select c.conname
    from pg_constraint c
    join pg_class t on t.oid = c.conrelid
    join pg_namespace n on n.oid = t.relnamespace
    where n.nspname = v_schema
      and t.relname = v_table
      and (
        exists (
          select 1
          from unnest(c.conkey) as ck(attnum)
          join pg_attribute a on a.attrelid = t.oid and a.attnum = ck.attnum
          where a.attname = v_column
        )
        or (c.contype = 'c' and pg_get_constraintdef(c.oid) ilike '%' || v_column || '%')
      )
  loop
    execute format('alter table %I.%I drop constraint if exists %I', v_schema, v_table, r.conname);
  end loop;
end
$$ language plpgsql;

do $$
declare
  v_schema text := 'public';
  v_table  text := 'colaboradores';
  v_column text := 'empresa_id';
  r record;
begin
  -- 4) Dropar triggers cujo corpo de funo mencione empresa_id
  for r in
    select t.tgname
    from pg_trigger t
    join pg_class tbl on tbl.oid = t.tgrelid
    join pg_namespace n on n.oid = tbl.relnamespace
    join pg_proc p on p.oid = t.tgfoid
    where not t.tgisinternal
      and n.nspname = v_schema
      and tbl.relname = v_table
      and pg_get_functiondef(p.oid) ilike '%' || v_column || '%'
  loop
    execute format('drop trigger if exists %I on %I.%I', r.tgname, v_schema, v_table);
  end loop;
end
$$ language plpgsql;

-- 5) Finalmente, dropar a coluna empresa_id (aps remoo de dependncias)
alter table public.colaboradores drop column if exists empresa_id;

-- 6) Garantir existencia de codigo_empresa e ndice (boa prtica)
do $$
begin
  if not exists (
    select 1 from information_schema.columns
    where table_schema = 'public' and table_name = 'colaboradores' and column_name = 'codigo_empresa'
  ) then
    alter table public.colaboradores add column codigo_empresa text;
  end if;

  if not exists (
    select 1 from pg_indexes
    where schemaname = 'public' and indexname = 'idx_colaboradores_codigo_empresa'
  ) then
    create index idx_colaboradores_codigo_empresa on public.colaboradores(codigo_empresa);
  end if;
end
$$ language plpgsql;

-- 6) Migrao para uso de codigo_empresa em quadras, clientes e agendamentos (com backfill de empresa_id, se existir)
--    Este bloco  idempotente e seguro para rodar mltiplas vezes.
--    Passos por tabela: adicionar coluna, backfill de empresa_id->codigo_empresa, criar FK e ndice, SET NOT NULL (se possvel), remoo opcional de empresa_id.

-- Helper: funo para verificar existncia de coluna
do $$
begin
  perform 1;
exception when others then null;
end$$;

-- 6.A) Utilitrio: adicionar coluna codigo_empresa se no existir (genrico)
do $$
declare
  v_schema text := 'public';
  v_table  text := 'NOME_DA_TABELA'; -- ajuste para a tabela alvo
  v_exists boolean;
begin
  select exists (
    select 1 from information_schema.columns
    where table_schema = v_schema
      and table_name   = v_table
      and column_name  = 'codigo_empresa'
  ) into v_exists;

  if not v_exists then
    execute format('alter table %I.%I add column codigo_empresa text', v_schema, v_table);
  end if;
exception when others then null;
end$$;

-- 6.B) Aplicar em uma lista de tabelas (ajuste a lista conforme necessrio)
do $$
declare
  v_schema text := 'public';
  t text;
  v_exists boolean;
  v_tables text[] := array[
    'agendamentos',
    'agendamento_participantes',
    'clientes',
    'colaboradores',
    'produtos',
    'quadras',
    'vendas'
  ];
begin
  foreach t in array v_tables loop
    select exists (
      select 1 from information_schema.columns
      where table_schema = v_schema
        and table_name   = t
        and column_name  = 'codigo_empresa'
    ) into v_exists;

    if not v_exists then
      execute format('alter table %I.%I add column codigo_empresa text', v_schema, t);
    end if;
  end loop;
exception when others then null;
end$$;

-- QUADRAS
do $$
declare
  v_has_col boolean;
  v_has_empid boolean;
  v_nulls int;
begin
  -- 6.1) Adicionar coluna codigo_empresa se no existir
  select exists (
    select 1 from information_schema.columns
    where table_schema='public' and table_name='quadras' and column_name='codigo_empresa'
  ) into v_has_col;
  if not v_has_col then
    execute $$alter table public.quadras add column codigo_empresa text$$;
  end if;

  -- 6.2) Backfill a partir de empresa_id, se existir
  select exists (
    select 1 from information_schema.columns
    where table_schema='public' and table_name='quadras' and column_name='empresa_id'
  ) into v_has_empid;
  if v_has_empid then
    execute $$update public.quadras q
             set codigo_empresa = e.codigo_empresa
             from public.empresas e
             where q.empresa_id = e.id and q.codigo_empresa is null$$;
  end if;

  -- 6.3) Tentar SET NOT NULL se no houver nulos
  execute $$select count(*) from public.quadras where codigo_empresa is null$$ into v_nulls;
  if v_nulls = 0 then
    begin execute $$alter table public.quadras alter column codigo_empresa set not null$$; exception when others then null; end;
  end if;

  -- 6.4) FK e ndice
  begin execute $$alter table public.quadras add constraint quadras_codigo_empresa_fkey foreign key (codigo_empresa) references public.empresas(codigo_empresa) on update cascade on delete restrict$$; exception when others then null; end;
  begin execute $$create index if not exists idx_quadras_codigo_empresa on public.quadras(codigo_empresa)$$; exception when others then null; end;

  -- 6.5) Remoo opcional de empresa_id
  if v_has_empid then
    -- dropar possveis FKs antigas
    begin execute $$alter table public.quadras drop constraint if exists quadras_empresa_id_fkey$$; exception when others then null; end;
    begin execute $$alter table public.quadras drop column if exists empresa_id$$; exception when others then null; end;
  end if;
exception when others then null;
end$$;

-- CLIENTES
do $$
declare
  v_has_col boolean;
  v_has_empid boolean;
  v_nulls int;
begin
  -- 6.1) Adicionar coluna
  select exists (
    select 1 from information_schema.columns
    where table_schema='public' and table_name='clientes' and column_name='codigo_empresa'
  ) into v_has_col;
  if not v_has_col then
    execute $$alter table public.clientes add column codigo_empresa text$$;
  end if;

  -- 6.2) Backfill
  select exists (
    select 1 from information_schema.columns
    where table_schema='public' and table_name='clientes' and column_name='empresa_id'
  ) into v_has_empid;
  if v_has_empid then
    execute $$update public.clientes c
             set codigo_empresa = e.codigo_empresa
             from public.empresas e
             where c.empresa_id = e.id and c.codigo_empresa is null$$;
  end if;

  -- 6.3) NOT NULL quando possvel
  execute $$select count(*) from public.clientes where codigo_empresa is null$$ into v_nulls;
  if v_nulls = 0 then
    begin execute $$alter table public.clientes alter column codigo_empresa set not null$$; exception when others then null; end;
  end if;

  -- 6.4) FK e ndice
  begin execute $$alter table public.clientes add constraint clientes_codigo_empresa_fkey foreign key (codigo_empresa) references public.empresas(codigo_empresa) on update cascade on delete restrict$$; exception when others then null; end;
  begin execute $$create index if not exists idx_clientes_codigo_empresa on public.clientes(codigo_empresa)$$; exception when others then null; end;

  -- 6.5) Remoo opcional de empresa_id
  if v_has_empid then
    begin execute $$alter table public.clientes drop constraint if exists clientes_empresa_id_fkey$$; exception when others then null; end;
    begin execute $$alter table public.clientes drop column if exists empresa_id$$; exception when others then null; end;
  end if;
exception when others then null;
end$$;

-- AGENDAMENTOS
do $$
declare
  v_has_col boolean;
  v_has_empid boolean;
  v_nulls int;
begin
  -- 6.1) Adicionar coluna
  select exists (
    select 1 from information_schema.columns
    where table_schema='public' and table_name='agendamentos' and column_name='codigo_empresa'
  ) into v_has_col;
  if not v_has_col then
    execute $$alter table public.agendamentos add column codigo_empresa text$$;
  end if;

  -- 6.2) Backfill
  select exists (
    select 1 from information_schema.columns
    where table_schema='public' and table_name='agendamentos' and column_name='empresa_id'
  ) into v_has_empid;
  if v_has_empid then
    execute $$update public.agendamentos a
             set codigo_empresa = e.codigo_empresa
             from public.empresas e
             where a.empresa_id = e.id and a.codigo_empresa is null$$;
  end if;

  -- 6.3) NOT NULL quando possvel
  execute $$select count(*) from public.agendamentos where codigo_empresa is null$$ into v_nulls;
  if v_nulls = 0 then
    begin execute $$alter table public.agendamentos alter column codigo_empresa set not null$$; exception when others then null; end;
  end if;

  -- 6.4) FK e ndice
  begin execute $$alter table public.agendamentos add constraint agendamentos_codigo_empresa_fkey foreign key (codigo_empresa) references public.empresas(codigo_empresa) on update cascade on delete restrict$$; exception when others then null; end;
  begin execute $$create index if not exists idx_agendamentos_codigo_empresa on public.agendamentos(codigo_empresa)$$; exception when others then null; end;

  -- 6.5) Remoo opcional de empresa_id
  if v_has_empid then
    begin execute $$alter table public.agendamentos drop constraint if exists agendamentos_empresa_id_fkey$$; exception when others then null; end;
    begin execute $$alter table public.agendamentos drop column if exists empresa_id$$; exception when others then null; end;
  end if;
exception when others then null;
end$$;

-- Observao: se existirem outras tabelas com empresa_id, repetir o padro acima ajustando nomes.

-- ============================
-- ATUALIZAES APLICADAS (v2.3)
-- Data: 2025-08-25
-- Motivo: Ajustar triggers e functions para uso de codigo_empresa
-- Observao: Idempotente (CREATE OR REPLACE / DROP TRIGGER IF EXISTS)
-- ============================

-- CLIENTES: funo geradora de cdigo sequencial por empresa (usa codigo_empresa)
create or replace function public.clientes_set_codigo_fn()
returns trigger
language plpgsql
security definer
set search_path = public
as $$
declare
  v_codigo_empresa text;
  v_empresa_id uuid;
  v_next integer;
begin
  if NEW.codigo_empresa is null then
    NEW.codigo_empresa := public.get_my_company_code();
  end if;
  v_codigo_empresa := NEW.codigo_empresa;

  select e.id
    into v_empresa_id
  from public.empresas e
  where e.codigo_empresa = v_codigo_empresa
  limit 1;

  if v_empresa_id is null then
    raise exception 'Empresa no encontrada para codigo_empresa=%', v_codigo_empresa;
  end if;

  if NEW.codigo is null then
    insert into public.empresa_counters (empresa_id, next_cliente_codigo)
    values (v_empresa_id, 1)
    on conflict (empresa_id) do nothing;

    select next_cliente_codigo
      into v_next
    from public.empresa_counters
    where empresa_id = v_empresa_id
    for update;

    NEW.codigo := v_next;

    update public.empresa_counters
    set next_cliente_codigo = v_next + 1
    where empresa_id = v_empresa_id;
  end if;

  return NEW;
end
$$;

drop trigger if exists zz_clientes_set_codigo on public.clientes;
create trigger zz_clientes_set_codigo
before insert on public.clientes
for each row
execute function public.clientes_set_codigo_fn();

-- AGENDAMENTOS: garantir codigo_empresa (fallback) a partir do usurio logado
create or replace function public.set_agendamento_empresa_from_user()
returns trigger
language plpgsql
security definer
set search_path = public
as $$
begin
  if NEW.codigo_empresa is null then
    NEW.codigo_empresa := public.get_my_company_code();
  end if;
  return NEW;
end
$$;

drop trigger if exists agendamentos_set_empresa_from_user on public.agendamentos;
create trigger agendamentos_set_empresa_from_user
before insert on public.agendamentos
for each row
execute function public.set_agendamento_empresa_from_user();

-- ============================
-- ATUALIZAES APLICADAS (v3)
-- Data: 2025-08-25
-- Motivo: Ajustes finais de schema para empresas por codigo_empresa
-- Observao: Blocos idempotentes (safe to run mltiplas vezes)
-- ============================

-- 1) EMPRESAS: garantir colunas e constraints principais
do $$
begin
  -- a) garantir coluna nome (obrigatria no app)
  begin execute $$alter table public.empresas add column if not exists nome text$$; exception when others then null; end;
  begin execute $$alter table public.empresas alter column nome set not null$$; exception when others then null; end;

  -- b) garantir codigo_empresa nico e not null
  begin execute $$alter table public.empresas alter column codigo_empresa set not null$$; exception when others then null; end;
  begin execute $$create unique index if not exists ux_empresas_codigo_empresa on public.empresas(codigo_empresa)$$; exception when others then null; end;

  -- c) notas: no existe coluna 'ativo' em empresas (ajustar polticas para no referenciar 'ativo')
  perform 1;
exception when others then null;
end$$;

-- 2) COLABORADORES: garantir colunas chave (codigo_empresa, ativo)
do $$
begin
  begin execute $$alter table public.colaboradores add column if not exists codigo_empresa text$$; exception when others then null; end;
  -- ativo pode no existir em alguns esquemas; o app usa quando presente
  begin execute $$alter table public.colaboradores add column if not exists ativo boolean$$; exception when others then null; end;
  -- ndice til
  begin execute $$create index if not exists idx_colaboradores_codigo_empresa on public.colaboradores(codigo_empresa)$$; exception when others then null; end;
exception when others then null;
end$$;

-- 3) FK/ndices por codigo_empresa (opcional, mas recomendado)
do $$
begin
  -- clientes
  begin execute $$create index if not exists idx_clientes_codigo_empresa on public.clientes(codigo_empresa)$$; exception when others then null; end;
  -- quadras
  begin execute $$create index if not exists idx_quadras_codigo_empresa on public.quadras(codigo_empresa)$$; exception when others then null; end;
  -- agendamentos (j aplicado acima em v2.3)
  perform 1;
exception when others then null;
end$$;

-- 4) Funes utilitrias (referncia)
-- get_my_company_code(): usar verso com fallback (ver estrutura_bd/politicas.txt v3)
-- Triggers clientes/agendamentos j publicados em v2.3

-- ============================
-- ATUALIZAES APLICADAS (v3.1)
-- Data: 2025-08-26
-- Motivo: Padronizar controle de pagamento por participante com enum payment_status e facilitar filtros
-- Observao: Blocos idempotentes (safe to run mltiplas vezes)
-- ============================

-- 1) Enum de status de pagamento (se no existir)
do $$
begin
  if not exists (select 1 from pg_type where typname = 'payment_status') then
    create type payment_status as enum ('Pendente','Pago','Pago parcial','Reembolsado');
  end if;
end$$;

-- 2) Normalizao de valores existentes na tabela base
update public.agendamento_participantes ap
set status_pagamento = case
  when status_pagamento is null or btrim(status_pagamento) = '' then 'Pendente'
  when lower(btrim(status_pagamento)) in ('pendente','pending') then 'Pendente'
  when lower(btrim(status_pagamento)) in ('pago','paid') then 'Pago'
  when lower(btrim(status_pagamento)) in ('pago parcial','parcial','partial','partial paid','parcialmente pago','partial_pago') then 'Pago parcial'
  when lower(btrim(status_pagamento)) in ('reembolsado','refunded') then 'Reembolsado'
  else 'Pendente'
end
where status_pagamento is distinct from case
  when status_pagamento is null or btrim(status_pagamento) = '' then 'Pendente'
  when lower(btrim(status_pagamento)) in ('pendente','pending') then 'Pendente'
  when lower(btrim(status_pagamento)) in ('pago','paid') then 'Pago'
  when lower(btrim(status_pagamento)) in ('pago parcial','parcial','partial','partial paid','parcialmente pago','partial_pago') then 'Pago parcial'
  when lower(btrim(status_pagamento)) in ('reembolsado','refunded') then 'Reembolsado'
  else 'Pendente'
end;

-- 3) Converter coluna status_pagamento (varchar) para enum payment_status com USING explcito e default
alter table public.agendamento_participantes
  alter column status_pagamento drop default;

alter table public.agendamento_participantes
  alter column status_pagamento type payment_status
  using (
    case
      when status_pagamento is null or btrim(status_pagamento) = '' then 'Pendente'::payment_status
      when lower(btrim(status_pagamento)) in ('pendente','pending') then 'Pendente'::payment_status
      when lower(btrim(status_pagamento)) in ('pago','paid') then 'Pago'::payment_status
      when lower(btrim(status_pagamento)) in ('pago parcial','parcial','partial','partial paid','parcialmente pago','partial_pago') then 'Pago parcial'::payment_status
      when lower(btrim(status_pagamento)) in ('reembolsado','refunded') then 'Reembolsado'::payment_status
      else 'Pendente'::payment_status
    end
  );

alter table public.agendamento_participantes
  alter column status_pagamento set default 'Pendente'::payment_status;

-- Opcional: obrigar preenchimento
-- alter table public.agendamento_participantes
--   alter column status_pagamento set not null;

-- 4) Coluna derivada em texto para filtros PostgREST e ndice (idempotentes)
alter table public.agendamento_participantes
  add column if not exists status_pagamento_text text
  generated always as (status_pagamento::text) stored;

do $$
begin
  if not exists (
    select 1 from pg_indexes
    where schemaname = 'public' and indexname = 'idx_agp_status_pagamento_text'
  ) then
    create index idx_agp_status_pagamento_text
      on public.agendamento_participantes (status_pagamento_text);
  end if;
end$$;

-- 5) View auxiliar para consumo (no duplicar coluna gerada)
create or replace view public.v_agendamento_participantes as
select ap.*
from public.agendamento_participantes ap;

-- ============================
-- ATUALIZAES APLICADAS (v3.2)
-- Data: 2025-08-26
-- Motivo: Garantir integridade referencial de codigo_empresa em agendamento_participantes e orientar filtros no frontend
-- Observao: Blocos idempotentes (safe to run mltiplas vezes)
-- ============================

-- 1) ndice por codigo_empresa
create index if not exists idx_agp_codigo_empresa
  on public.agendamento_participantes(codigo_empresa);

-- 2) FK codigo_empresa -> empresas(codigo_empresa)
do $pl$
begin
  if not exists (
    select 1
    from pg_constraint c
    join pg_class t on t.oid = c.conrelid
    join pg_namespace n on n.oid = t.relnamespace
    where n.nspname = 'public'
      and t.relname = 'agendamento_participantes'
      and c.conname = 'agp_codigo_empresa_fkey'
  ) then
    execute 'alter table public.agendamento_participantes
               add constraint agp_codigo_empresa_fkey
               foreign key (codigo_empresa)
               references public.empresas(codigo_empresa)
               on update cascade
               on delete restrict';
  end if;
end
$pl$;

-- 3) Diagnstico (opcional) para inconsistncias antes de validar FK
-- select ap.*
-- from public.agendamento_participantes ap
-- left join public.empresas e on e.codigo_empresa = ap.codigo_empresa
-- where e.codigo_empresa is null or ap.codigo_empresa is null;

-- 4) Nota para o frontend:
--    - Para filtrar por status de pagamento via PostgREST, use status_pagamento_text (ex.: eq=Pago)
--    - Ou use cast explcito no SQL: where status_pagamento = 'Pago'::payment_status

-- ============================
-- ATUALIZAES APLICADAS (v3.3)
-- Data: 2025-08-26
-- Motivo: Remover empresa_id de agendamento_participantes e padronizar por codigo_empresa
-- Observao: Idempotente (DROP IF EXISTS)
-- ============================

-- 1) Remover FK antiga e coluna empresa_id (se ainda existirem)
alter table public.agendamento_participantes
  drop constraint if exists agp_empresa_id_fkey;

alter table public.agendamento_participantes
  drop column if exists empresa_id;

-- 2) Observao: Escopo de empresa nesta tabela fica apenas por codigo_empresa
--    (FK agp_codigo_empresa_fkey j definido em v3.2)

-- ============================
-- ATUALIZAES APLICADAS (v3.4)
-- Data: 2025-08-26
-- Motivo: Persistncia de categorias de produtos por empresa (produto_categorias)
--         e suporte a cdigo de produto com ndice nico por empresa
-- Observao: Blocos idempotentes (safe to run mltiplas vezes)
-- ============================

-- 1) Tabela de categorias por empresa
do $$
begin
  -- criar tabela se no existir
  begin
    execute $$create table if not exists public.produto_categorias (
      id uuid primary key default gen_random_uuid(),
      codigo_empresa text not null,
      nome text not null,
      descricao text,
      ativa boolean not null default true,
      created_at timestamptz not null default now(),
      updated_at timestamptz not null default now()
    )$$;
  exception when others then null; end;

  -- garantir ndice nico por empresa + nome (case-insensitive)
  begin execute $$create unique index if not exists ux_produto_categorias_empresa_nome on public.produto_categorias (codigo_empresa, lower(nome))$$; exception when others then null; end;
  -- ndice por empresa para filtros
  begin execute $$create index if not exists idx_produto_categorias_codigo_empresa on public.produto_categorias (codigo_empresa)$$; exception when others then null; end;

  -- trigger: preencher codigo_empresa via get_my_company_code()
  begin
    execute $$create or replace function public.produto_categorias_set_empresa_fn()
    returns trigger
    language plpgsql
    security definer
    set search_path = public
    as $$
    begin
      if NEW.codigo_empresa is null then
        NEW.codigo_empresa := public.get_my_company_code();
      end if;
      return NEW;
    end
    $$;$$;
  exception when others then null; end;

  begin execute $$drop trigger if exists zz_produto_categorias_set_empresa on public.produto_categorias$$; exception when others then null; end;
  begin execute $$create trigger zz_produto_categorias_set_empresa
    before insert on public.produto_categorias
    for each row
    execute function public.produto_categorias_set_empresa_fn()$$; exception when others then null; end;

  -- trigger: atualizar updated_at
  begin
    execute $$create or replace function public.set_updated_at()
    returns trigger
    language plpgsql
    as $$
    begin
      NEW.updated_at := now();
      return NEW;
    end
    $$;$$;
  exception when others then null; end;

  begin execute $$drop trigger if exists zz_produto_categorias_touch on public.produto_categorias$$; exception when others then null; end;
  begin execute $$create trigger zz_produto_categorias_touch
    before update on public.produto_categorias
    for each row
    execute function public.set_updated_at()$$; exception when others then null; end;
end$$;

-- ============================
-- ATUALIZAES APLICADAS (v3.7)
-- Data: 2025-08-31
-- Motivo: Tabelas PDV (mesas, comandas, comanda_itens, caixa_sessoes) e ajustes em pagamentos
-- Observao: Blocos idempotentes (safe to run multiple times)
-- ============================

-- 1) MESAS
do $$
begin
  -- criar tabela
  execute $$create table if not exists public.mesas (
    id uuid primary key default gen_random_uuid(),
    codigo_empresa text not null default public.get_my_company_code(),
    numero integer not null,
    status text not null default 'available',
    created_at timestamptz default now()
  )$$;

  -- ndices e unique por empresa
  begin execute $$create index if not exists idx_mesas_empresa on public.mesas (codigo_empresa)$$; exception when others then null; end;
  begin execute $$create unique index if not exists ux_mesas_empresa_numero on public.mesas (codigo_empresa, numero)$$; exception when others then null; end;
end$$;

-- 2) COMANDAS
do $$
begin
  execute $$create table if not exists public.comandas (
    id uuid primary key default gen_random_uuid(),
    codigo_empresa text not null default public.get_my_company_code(),
    mesa_id uuid,
    status text not null default 'open',
    aberto_em timestamptz default now(),
    fechado_em timestamptz
  )$$;

  -- FK para mesas (se existir)
  begin
    if not exists (select 1 from information_schema.constraint_column_usage where constraint_name = 'fk_comandas_mesa') then
      execute $$alter table public.comandas add constraint fk_comandas_mesa foreign key (mesa_id) references public.mesas(id) on delete set null$$;
    end if;
  exception when others then null; end;

  -- ndices
  begin execute $$create index if not exists idx_comandas_empresa on public.comandas (codigo_empresa)$$; exception when others then null; end;
  begin execute $$create index if not exists idx_comandas_mesa on public.comandas (mesa_id)$$; exception when others then null; end;
  begin execute $$create index if not exists idx_comandas_status on public.comandas (status)$$; exception when others then null; end;
end$$;

-- 3) COMANDA_ITENS
do $$
begin
  execute $$create table if not exists public.comanda_itens (
    id uuid primary key default gen_random_uuid(),
    codigo_empresa text not null default public.get_my_company_code(),
    comanda_id uuid not null,
    produto_id uuid,
    descricao text,
    quantidade numeric(12,3) not null default 1,
    preco_unitario numeric(12,2) not null default 0,
    desconto numeric(12,2) not null default 0,
    created_at timestamptz default now()
  )$$;

  -- FKs
  begin
    if not exists (select 1 from information_schema.constraint_column_usage where constraint_name = 'fk_comanda_itens_comanda') then
      execute $$alter table public.comanda_itens add constraint fk_comanda_itens_comanda foreign key (comanda_id) references public.comandas(id) on delete cascade$$;
    end if;
  exception when others then null; end;

  -- ndices
  begin execute $$create index if not exists idx_comanda_itens_empresa on public.comanda_itens (codigo_empresa)$$; exception when others then null; end;
  begin execute $$create index if not exists idx_comanda_itens_comanda on public.comanda_itens (comanda_id)$$; exception when others then null; end;
end$$;

-- 4) CAIXA_SESSOES
do $$
begin
  execute $$create table if not exists public.caixa_sessoes (
    id uuid primary key default gen_random_uuid(),
    codigo_empresa text not null default public.get_my_company_code(),
    status text not null default 'open',
    aberto_em timestamptz default now(),
    fechado_em timestamptz,
    saldo_inicial numeric(12,2) default 0,
    saldo_final numeric(12,2)
  )$$;

  -- ndices
  begin execute $$create index if not exists idx_caixa_sessoes_empresa on public.caixa_sessoes (codigo_empresa)$$; exception when others then null; end;
  begin execute $$create index if not exists idx_caixa_sessoes_status on public.caixa_sessoes (status)$$; exception when others then null; end;
end$$;

-- 5) AJUSTES EM PAGAMENTOS (caixa_id, recebido_em)
do $$
begin
  -- adicionar coluna caixa_id e FK
  begin execute $$alter table public.pagamentos add column if not exists caixa_id uuid$$; exception when others then null; end;
  begin
    if not exists (select 1 from information_schema.constraint_column_usage where constraint_name = 'fk_pagamentos_caixa') then
      execute $$alter table public.pagamentos add constraint fk_pagamentos_caixa foreign key (caixa_id) references public.caixa_sessoes(id) on delete set null$$;
    end if;
  exception when others then null; end;

  -- adicionar recebido_em (mantm created_at como histrico)
  begin execute $$alter table public.pagamentos add column if not exists recebido_em timestamptz default now()$$; exception when others then null; end;

  -- ndices auxiliares
  begin execute $$create index if not exists idx_pagamentos_caixa on public.pagamentos (caixa_id)$$; exception when others then null; end;
end$$;

-- 6) AJUSTES EM COMANDAS: cliente_id e cliente_nome
do $$
begin
  -- adicionar colunas (nullable) para associao de cliente
  begin execute $$alter table public.comandas add column if not exists cliente_id uuid$$; exception when others then null; end;
  begin execute $$alter table public.comandas add column if not exists cliente_nome text$$; exception when others then null; end;

  -- FK opcional para clientes (se existir)
  begin
    if not exists (select 1 from information_schema.constraint_column_usage where constraint_name = 'fk_comandas_cliente') then
      execute $$alter table public.comandas add constraint fk_comandas_cliente foreign key (cliente_id) references public.clientes(id) on delete set null$$;
    end if;
  exception when others then null; end;

  -- ndices auxiliares
  begin execute $$create index if not exists idx_comandas_cliente on public.comandas (cliente_id)$$; exception when others then null; end;
end$$;

-- 2) Backfill opcional: popular categorias a partir de produtos existentes (distintos por empresa)
insert into public.produto_categorias (codigo_empresa, nome)
select distinct on (p.codigo_empresa, lower(coalesce(p.categoria,'')))
  p.codigo_empresa,
  coalesce(p.categoria,'') as nome
from public.produtos p
where coalesce(p.categoria,'') <> ''
  and not exists (
    select 1 from public.produto_categorias c
    where c.codigo_empresa = p.codigo_empresa
      and lower(c.nome) = lower(p.categoria)
  )
  and p.codigo_empresa is not null
on conflict do nothing;

-- 3) Produtos: garantir coluna codigo_produto e ndice nico por empresa (ignora null)
do $$
begin
  -- coluna
  begin execute $$alter table public.produtos add column if not exists codigo_produto text$$; exception when others then null; end;
  -- ndice nico escopo empresa
  if not exists (
    select 1 from pg_indexes where schemaname = 'public' and indexname = 'ux_produtos_empresa_codigo_produto'
  ) then
    execute $$create unique index ux_produtos_empresa_codigo_produto
      on public.produtos (codigo_empresa, codigo_produto)
      where codigo_produto is not null$$;
  end if;
  -- ndice auxiliar para busca por cdigo
  begin execute $$create index if not exists idx_produtos_codigo_produto on public.produtos (codigo_produto)$$; exception when others then null; end;
end$$;

-- ============================
-- ATUALIZAES APLICADAS (v3.5)
-- Data: 2025-08-26
-- Motivo: Remover CHECK legado de status_pagamento, garantir defaults/NOT NULL e recriar view compatvel com o frontend
-- Observao: Blocos idempotentes (safe to run mltiplas vezes)
-- ============================

-- 1) Remover quaisquer CHECK constraints legadas que referenciem status_pagamento em agendamento_participantes
do $$
declare
  r record;
begin
  for r in
    select c.conname
    from pg_constraint c
    join pg_class t on t.oid = c.conrelid
    join pg_namespace n on n.oid = t.relnamespace
    where n.nspname = 'public'
      and t.relname  = 'agendamento_participantes'
      and c.contype  = 'c'
      and pg_get_constraintdef(c.oid) ilike '%status_pagamento%'
  loop
    execute format('alter table public.agendamento_participantes drop constraint if exists %I', r.conname);
  end loop;
end$$;

-- 2) Garantir defaults e NOT NULL
-- valor_cota: default 0 e NOT NULL
begin
  alter table public.agendamento_participantes
    alter column valor_cota set default 0;
  alter table public.agendamento_participantes
    alter column valor_cota set not null;
exception when others then
  -- mantm idempotncia caso j aplicados
  perform 1;
end;

-- status_pagamento: default 'Pendente'::payment_status e (opcional) NOT NULL
begin
  alter table public.agendamento_participantes
    alter column status_pagamento set default 'Pendente'::payment_status;
  alter table public.agendamento_participantes
    alter column status_pagamento set not null;
exception when others then
  perform 1;
end;

-- 3) Recriar a view esperada pelo front: inclui nome do cliente e coluna status_pagamento_text
create or replace view public.v_agendamento_participantes as
select
  ap.id,
  ap.agendamento_id,
  ap.codigo_empresa,
  ap.cliente_id,
  c.nome,
  ap.valor_cota,
  (ap.status_pagamento::text) as status_pagamento_text,
  ap.status_pagamento
from public.agendamento_participantes ap
join public.clientes c on c.id = ap.cliente_id;

-- ============================
-- DOCUMENTAO (v_agendamento_participantes)
-- Data: 2025-08-27
-- Descrio:
--   View somente leitura usada pela Agenda para listar participantes de um agendamento
--   com os campos j prontos para UI: nome do cliente e status_pagamento_text.
--   A fonte de verdade continua sendo a tabela public.agendamento_participantes.
--
-- Campos expostos:
--   id, agendamento_id, codigo_empresa, cliente_id, nome, valor_cota,
--   status_pagamento_text (derivado), status_pagamento (enum).
--
-- Observaes:
--   - No fazer INSERT/UPDATE/DELETE na view; usar a tabela base.
--   - Segurana/RLS  aplicada nas tabelas base; ver detalhes em `estrutura_bd/politicas.txt`.

-- ============================
-- ATUALIZAES APLICADAS (v3.5)
-- Data: 2025-08-28
-- Motivo: Adicionar colunas fiscais em public.produtos e criar/garantir public.produto_categorias
-- Observao: Blocos idempotentes (safe to run multiple times)
-- ============================

-- 1) Tabela de categorias de produto (usada pelo front via src/lib/products.js)
create table if not exists public.produto_categorias (
  id uuid primary key default gen_random_uuid(),
  codigo_empresa text not null default public.get_my_company_code(),
  nome varchar(100) not null,
  ativa boolean not null default true,
  criado_em timestamptz default now(),
  atualizado_em timestamptz default now()
);
create unique index if not exists produto_categorias_empresa_nome_unique
  on public.produto_categorias (codigo_empresa, lower(nome));
create index if not exists idx_produto_categorias_empresa
  on public.produto_categorias (codigo_empresa);

-- 2) Produtos: garantir default de codigo_empresa via funo SECURITY DEFINER
do $$
begin
  perform 1;
  execute $$alter table public.produtos alter column codigo_empresa set default public.get_my_company_code()$$;
exception when others then null;
end$$;

-- 3) Produtos: adicionar/garantir colunas utilizadas pelo front (fiscais e parmetros)
alter table public.produtos
  add column if not exists codigo_produto varchar(50),
  add column if not exists categoria varchar(100),
  add column if not exists valor_venda numeric(12,2),
  add column if not exists preco_compra numeric(12,2),
  add column if not exists preco_custo numeric(12,2),
  add column if not exists preco_atacado numeric(12,2),
  add column if not exists qtd_atacado integer,
  add column if not exists custos_percent numeric(9,4),
  add column if not exists lucro_percent numeric(9,4),
  add column if not exists comissao_percent numeric(9,4),
  add column if not exists desconto_percent numeric(9,4),
  add column if not exists estoque_inicial integer,
  add column if not exists estoque_atual integer,
  add column if not exists peso numeric(12,3),
  add column if not exists codigo_barras varchar(64),
  add column if not exists codigo_barras_caixa varchar(64),
  add column if not exists referencia varchar(100),
  add column if not exists marca varchar(100),
  add column if not exists grupo varchar(100),
  add column if not exists unidade varchar(10),
  add column if not exists cfop_interno varchar(10),
  add column if not exists cst_icms_interno varchar(3),
  add column if not exists csosn_interno varchar(3),
  add column if not exists aliquota_icms_interno numeric(9,4),
  add column if not exists cfop_externo varchar(10),
  add column if not exists cst_icms_externo varchar(3),
  add column if not exists csosn_externo varchar(3),
  add column if not exists aliquota_icms_externo numeric(9,4),
  add column if not exists cst_pis_entrada varchar(2),
  add column if not exists cst_pis_saida varchar(2),
  add column if not exists aliquota_pis_percent numeric(9,4),
  add column if not exists aliquota_cofins_percent numeric(9,4),
  add column if not exists cst_ipi varchar(2),
  add column if not exists aliquota_ipi_percent numeric(9,4),
  add column if not exists fcp_percent numeric(9,4),
  add column if not exists mva_percent numeric(9,4),
  add column if not exists base_reduzida_percent numeric(9,4),
  add column if not exists ncm varchar(10),
  add column if not exists descricao_ncm varchar(255),
  add column if not exists cest varchar(10),
  add column if not exists ativo boolean default true,
  add column if not exists permite_venda boolean default true,
  add column if not exists paga_comissao boolean default false,
  add column if not exists preco_variavel boolean default false,
  add column if not exists composicao boolean default false,
  add column if not exists servico boolean default false,
  add column if not exists grade boolean default false,
  add column if not exists usar_tabela_preco boolean default false,
  add column if not exists combustivel boolean default false,
  add column if not exists usa_imei boolean default false,
  add column if not exists controle_estoque_por_grade boolean default false,
  add column if not exists mostrar_no_app boolean default false;

-- 4) ndices/uniques de apoio
create unique index if not exists ux_produtos_empresa_codigo_produto
  on public.produtos (codigo_empresa, codigo_produto) where codigo_produto is not null;
create index if not exists idx_produtos_categoria on public.produtos (categoria);

-- ============================
-- ATUALIZAES APLICADAS (v3.6)
-- Data: 2025-08-31
-- Motivo: Finalizadoras (CRUD) e Pagamentos: remoo de 'ordem', padronizao por codigo_empresa,
--         e garantia de NOT NULL em pagamentos.metodo para compatibilidade com o frontend/PDV
-- Observao: Blocos idempotentes (safe to run multiple times)
-- ============================

-- 1) FINALIZADORAS
do $$
begin
  -- criar tabela caso no exista (idempotente)
  execute $$create table if not exists public.finalizadoras (
    id uuid primary key default gen_random_uuid(),
    codigo_empresa text not null default public.get_my_company_code(),
    nome text not null,
    tipo text,
    ativo boolean not null default true,
    created_at timestamptz default now(),
    updated_at timestamptz default now()
  )$$;

  -- remover campo legado 'ordem' caso exista
  begin execute $$alter table public.finalizadoras drop column if exists ordem$$; exception when others then null; end;

  -- garantir ndice por empresa e unique (empresa, lower(nome)) para evitar duplicatas por nome
  begin execute $$create index if not exists idx_finalizadoras_empresa on public.finalizadoras (codigo_empresa)$$; exception when others then null; end;
  begin execute $$create unique index if not exists ux_finalizadoras_empresa_nome on public.finalizadoras (codigo_empresa, lower(nome))$$; exception when others then null; end;

  -- trigger para updated_at
  execute $$create or replace function public.finalizadoras_set_updated_at() returns trigger language plpgsql as $$
  begin
    new.updated_at := now();
    return new;
  end $$;$$;
  begin execute $$drop trigger if exists zz_finalizadoras_touch on public.finalizadoras$$; exception when others then null; end;
  begin execute $$create trigger zz_finalizadoras_touch before update on public.finalizadoras for each row execute function public.finalizadoras_set_updated_at()$$; exception when others then null; end;
end$$;

-- 2) PAGAMENTOS
do $$
begin
  -- criar tabela caso no exista (idempotente). Ajuste os campos conforme o seu schema real
  execute $$create table if not exists public.pagamentos (
    id uuid primary key default gen_random_uuid(),
    comanda_id uuid,
    finalizadora_id uuid,
    codigo_empresa text not null default public.get_my_company_code(),
    metodo text not null,
    valor numeric(12,2) not null default 0,
    status text,
    created_at timestamptz default now()
  )$$;

  -- garantir coluna metodo NOT NULL (frente envia sempre)
  begin
    execute $$alter table public.pagamentos alter column metodo set not null$$;
  exception when others then null;
  end;

  -- garantir coluna finalizadora_id e FK (se possvel)
  begin execute $$alter table public.pagamentos add column if not exists finalizadora_id uuid$$; exception when others then null; end;
  begin
    if not exists (
      select 1 from pg_constraint where conname = 'fk_pagamentos_finalizadora'
    ) then
      execute $$alter table public.pagamentos add constraint fk_pagamentos_finalizadora foreign key (finalizadora_id) references public.finalizadoras(id) on delete restrict$$;
    end if;
  exception when others then null; end;

  -- ndices auxiliares
  begin execute $$create index if not exists idx_pagamentos_empresa on public.pagamentos (codigo_empresa)$$; exception when others then null; end;
  begin execute $$create index if not exists idx_pagamentos_comanda on public.pagamentos (comanda_id)$$; exception when others then null; end;
  begin execute $$create index if not exists idx_pagamentos_finalizadora on public.pagamentos (finalizadora_id)$$; exception when others then null; end;
end$$;